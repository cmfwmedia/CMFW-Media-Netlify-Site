<!DOCTYPE html>
<html lang="en" charset="utf-8">

{{- partial "head.html" . -}}

<body class="d-flex h-100 text-center">
  <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">


    {{ partial "header.html" . }}

    <div id="content">
      {{- block "main" . }}{{- end }}
    </div>
    <div id="injection" class="container-fluid mt-4"></div>

    {{ partial "footer.html" . }}
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fetchDb = document.getElementById('fetch-db')
      const drone = document.getElementById('drone')
      const place = document.getElementById('place')
      const customer = document.getElementById('customer')
      const equipment = document.getElementById('equipment')
      const company = document.getElementById('company')
      const flight = document.getElementById('flight')
      const user = document.getElementById('user')
      const project = document.getElementById('project')

      window.addEventListener('load', async () => {

        const SpecificDroneUrl = "https://www.dronelogbook.com/inventory/droneDetail.php?id="
        // Initializing the starting object
        const initialObject = {
          name: "",
          brand: "",
          model: "",
          guid: "",
          flight_duration: 0,
          flight_distance: 0,
          num_of_flights: 0,
          image_url: "",
          dronelogbook_url: "",
          status: ""
        };

        // Initializing an empty array to store aggregated data
        const aggregatedData = [];
        try {
          console.log('Window loaded. Fetching data...');

          const response = await fetch('https://cmfw-media-netlify-site.netlify.app/.netlify/functions/fetchDb')
            .then(response => response.json());

          // console.log('Response:', response.data);
          // console.log(response.data.drone)
          // console.log(initialObject)
          // Assuming response.data.drone is the array to iterate through
          response.data.drone.forEach(item => {
            // Create a copy of the initialObject
            const newObj = { ...initialObject };

            // Update the copied object with values from the response
            newObj.name = item.name; // Assuming brand should be used for name
            newObj.brand = item.brand;
            newObj.model = item.model;
            newObj.guid = item.guid;
            newObj.status = item.status;

            // Push the updated object to aggregatedData
            aggregatedData.push(newObj);

            response.data.flight.forEach(flight => {
              const { distance, duration_seconds, drone_guid } = flight;

              // Find the corresponding drone_guid in aggregatedData
              const matchedDrone = aggregatedData.find(drone => drone.guid === drone_guid);

              if (matchedDrone) {
                // Update aggregatedData with flight duration and increment num_of_flights
                matchedDrone.flight_duration += Number(duration_seconds);
                matchedDrone.flight_distance += Number(distance);
                matchedDrone.num_of_flights += 1;
              }

              aggregatedData.forEach(item => {
                item.dronelogbook_url = `${SpecificDroneUrl}${item.guid}`;

              });
              for (const item of aggregatedData) {
                if (response.data.drone_image_links[item.guid]) {
                  item.image_url = response.data.drone_image_links[item.guid];
                }
              }

            });

          });

          // Logging the aggregated data for demonstration purposes
          console.log(aggregatedData);

          const injectionDiv = document.getElementById('injection');


          // Create a Bootstrap row
          const row = document.createElement('div');
          row.classList.add('row', 'row-cols-1', 'row-cols-md-2', 'g-4');

          // Loop through the JSON data array
          aggregatedData.forEach(item => {
            // Create a column for each item
            const column = document.createElement('div');
            column.classList.add('col');

            // Create Bootstrap card element
            const card = document.createElement('div');
            card.classList.add('card', 'h-100');

            // Create card body
            const cardBody = document.createElement('div');
            cardBody.classList.add('card-body');

            // Create and set the image (assuming item.image_url contains the image URL)
            const image = document.createElement('img');
            image.classList.add('img-fluid', 'mb-3');
            image.setAttribute('src', item.image_url);
            image.setAttribute('alt', item.name);

            // Create h5 tag with item name
            const title = document.createElement('h5');
            title.classList.add('card-title');
            title.textContent = item.name;

            // Create p tags with item details
            const details = document.createElement('p');
            details.textContent = `${item.brand} ${item.model}`;

            const flights = document.createElement('p');
            flights.textContent = `Number of flights: ${item.num_of_flights}`;

            const duration = document.createElement('p');
            const totalDuration = formatDuration(item.flight_duration);
            duration.textContent = `Total Flight Duration: ${totalDuration}`;

            const distance = document.createElement('p');
            const totalDistance = convertMetersToMiles(item.flight_distance).toFixed(2);
            distance.textContent = `Total Distance Flown: ${totalDistance} miles`;

            const status = document.createElement('p');
            status.textContent = `Status: ${item.status}`;

            // Append elements to card body
            cardBody.appendChild(image);
            cardBody.appendChild(title);
            cardBody.appendChild(details);
            cardBody.appendChild(flights);
            cardBody.appendChild(duration);
            cardBody.appendChild(distance);
            cardBody.appendChild(status);

            // Append card body to card and card to column
            card.appendChild(cardBody);
            column.appendChild(card);

            // Append column to row
            row.appendChild(column);
          });

          // Append row to injectionDiv
          injectionDiv.appendChild(row);



        } catch (error) {
          console.error('Error:', error);
        }
      });

    })
    function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const remainingSeconds = seconds % 60;
    return `${hours}:${minutes < 10 ? '0' : ''}${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
  }

  // Function to convert meters to miles
  function convertMetersToMiles(meters) {
    const metersToMiles = 0.000621371;
    return meters * metersToMiles;
  }

  </script>

</body>

</html>